<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>해기사 문제풀이</title>
    <!-- Tailwind CSS CDN을 사용하여 스타일링 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        /* 풀이 텍스트의 줄바꿈을 유지 */
        .whitespace-pre-wrap {
            white-space: pre-wrap;
        }
        /* 스크롤바 스타일링 (선택 사항) */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0; /* gray-200 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8; /* gray-400 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* gray-500 */
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 w-full max-w-5xl flex flex-col md:flex-row gap-6">
        <!-- 로딩 및 에러 메시지 표시 영역 -->
        <div id="loading-message" class="absolute inset-0 bg-gray-100 bg-opacity-75 flex items-center justify-center z-10">
            <p class="text-xl text-gray-700">문제 데이터를 불러오는 중입니다...</p>
        </div>
        <div id="error-message" class="absolute inset-0 bg-red-100 bg-opacity-75 flex items-center justify-center z-10 hidden">
            <p class="text-xl text-red-700 p-4 rounded-lg"></p>
        </div>
        <div id="no-data-message" class="absolute inset-0 bg-yellow-100 bg-opacity-75 flex items-center justify-center z-10 hidden">
            <p class="text-xl text-yellow-700 p-4 rounded-lg">문제 데이터가 없습니다. Google Sheet를 확인해주세요.</p>
        </div>

        <!-- 필터링 섹션 -->
        <div id="filter-section" class="w-full md:w-1/2 lg:w-2/5 p-4 bg-blue-50 rounded-xl shadow-md flex flex-col justify-center items-center text-center">
            <h2 class="text-3xl md:text-4xl font-bold text-blue-800 mb-6">문제 필터링</h2>
            <p class="text-gray-700 mb-6">원하는 조건으로 문제를 필터링하여 풀이할 수 있습니다.</p>
            
            <div class="space-y-4 w-full max-w-xs">
                <button id="continue-quiz-button" class="hidden w-full max-w-xs bg-green-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-green-700 transition-colors shadow-md mb-4">
                    이어하기
                </button>
                <div>
                    <label for="filter-year" class="block text-left text-sm font-medium text-gray-700 mb-1">연도</label>
                    <select id="filter-year" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                </div>
                <div>
                    <label for="filter-round" class="block text-left text-sm font-medium text-gray-700 mb-1">회차</label>
                    <select id="filter-round" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                </div>
                <div>
                    <label for="filter-grade" class="block text-left text-sm font-medium text-gray-700 mb-1">급수</label>
                    <select id="filter-grade" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                </div>
                <div>
                    <label for="filter-shiptype" class="block text-left text-sm font-medium text-gray-700 mb-1">선종</label>
                    <select id="filter-shiptype" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                </div>
            </div>
            <button id="start-quiz-button" class="mt-8 w-full max-w-xs bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-blue-700 transition-colors shadow-md">
                문제풀이 시작
            </button>
        </div>

        <!-- 문제 풀이 영역 -->
        <div id="quiz-container" class="w-full md:w-3/4 hidden flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl md:text-3xl font-bold text-blue-700">해기사 문제풀이</h2>
                <button id="back-to-home-button" class="text-sm text-gray-500 hover:text-blue-600 transition-colors">
                    처음 화면으로
                </button>
            </div>

            <div class="mb-4 text-sm text-gray-600">
                <span id="problem-meta-year"></span>년 |
                <span id="problem-meta-round"></span>회차 |
                <span id="problem-meta-grade"></span>급 |
                <span id="problem-meta-shiptype"></span> |
                <span id="problem-meta-subject"></span>
            </div>
            <div class="mb-6">
                <!-- 문제 번호와 문제 내용 표시 -->
                <p class="text-lg font-semibold text-gray-800 mb-2">
                    <span id="problem-number" class="text-blue-500"></span> <span id="problem-question"></span>
                </p>
                <ul id="options-list" class="space-y-3">
                    <!-- 보기 버튼들이 여기에 동적으로 삽입됩니다 -->
                </ul>
            </div>

            <!-- 풀이 영역 -->
            <div id="solution-area" class="mt-6 p-4 rounded-lg bg-yellow-50 border border-yellow-300 text-yellow-800 hidden">
                <h3 class="font-bold text-lg mb-2">풀이:</h3>
                <p id="solution-text" class="whitespace-pre-wrap"></p>
                <button
                    id="next-problem-button"
                    class="mt-4 w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                >
                    다음 문제
                </button>
            </div>
        </div>

        <!-- 문제 목록 사이드바 -->
        <div id="problem-list-sidebar" class="w-full md:w-1/4 bg-gray-50 p-4 rounded-xl shadow-md hidden md:block overflow-y-auto max-h-[80vh]">
            <h3 class="text-xl font-bold text-gray-700 mb-4">문제 목록</h3>
            <ul id="sidebar-problem-numbers" class="grid grid-cols-5 gap-2">
                <!-- 문제 번호들이 여기에 동적으로 삽입됩니다 -->
            </ul>
        </div>
    </div>

    <script>
        // 여기에 Google 스프레드시트의 TSV 링크를 붙여넣으세요!
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRpZGh9h95OtuFdBgUme_sC9n7WjRLZ1LIo8_GXRN2Fsbhu0CnndlXqP_iAPHq3aZJu9yooWY18CFYz/pub?gid=0&single=true&output=tsv'; 
        const LOCAL_STORAGE_KEY = 'maritimeExamProgress';

        let allProblems = []; // 모든 문제 데이터
        let filteredProblems = []; // 필터링된 문제 데이터
        let currentProblemIndex = 0;
        let showSolution = false;
        let isAnsweredCorrectly = null; // null: 아직 선택 안 함, true: 정답, false: 오답
        let selectedShiptypeForQuiz = ''; // 문제풀이 화면에 표시할 선종

        // DOM 요소 가져오기
        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');
        const noDataMessage = document.getElementById('no-data-message');
        const filterSection = document.getElementById('filter-section');
        const quizContainer = document.getElementById('quiz-container');
        const problemListSidebar = document.getElementById('problem-list-sidebar'); // 사이드바 컨테이너
        const continueQuizButton = document.getElementById('continue-quiz-button');
        const backToHomeButton = document.getElementById('back-to-home-button');

        const problemMetaYear = document.getElementById('problem-meta-year');
        const problemMetaRound = document.getElementById('problem-meta-round');
        const problemMetaGrade = document.getElementById('problem-meta-grade');
        const problemMetaShiptype = document.getElementById('problem-meta-shiptype');
        const problemMetaSubject = document.getElementById('problem-meta-subject');
        const problemNumberSpan = document.getElementById('problem-number');
        const problemQuestionSpan = document.getElementById('problem-question');
        const optionsList = document.getElementById('options-list');
        const solutionArea = document.getElementById('solution-area');
        const solutionText = document.getElementById('solution-text');
        const nextProblemButton = document.getElementById('next-problem-button');

        // 필터 드롭다운 요소
        const filterYear = document.getElementById('filter-year');
        const filterRound = document.getElementById('filter-round');
        const filterGrade = document.getElementById('filter-grade');
        const filterShiptype = document.getElementById('filter-shiptype');
        const startQuizButton = document.getElementById('start-quiz-button');
        const sidebarProblemNumbers = document.getElementById('sidebar-problem-numbers'); // 사이드바 문제 번호 목록

        // 보기1~4를 '가', '나', '사', '아'로 매핑하기 위한 객체
        const optionLabels = {
            '보기1': '가',
            '보기2': '나',
            '보기3': '사',
            '보기4': '아',
        };

        // 과목 풀이 순서 정의
        const subjectOrder = ['항해', '운용', '법규', '영어', '상선전문', '어선전문'];

        // TSV 텍스트를 파싱하여 문제 객체 배열로 변환하는 함수
        const parseTsv = (tsvText) => {
            const lines = tsvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) {
                console.warn("TSV 데이터에 헤더 또는 내용이 부족합니다.");
                return [];
            }

            const headers = lines[0].split('\t').map(h => h.trim());
            console.log("TSV 파싱 - 헤더:", headers);

            const data = lines.slice(1).map(line => {
                const values = line.split('\t').map(v => v.trim());
                let problem = {};
                headers.forEach((header, index) => {
                    problem[header] = values[index];
                });
                return problem;
            });
            console.log("TSV 파싱 - 첫 번째 문제 객체:", data[0]);
            return data;
        };

        // 문제 데이터를 불러오는 함수
        const fetchProblems = async () => {
            loadingMessage.classList.remove('hidden');
            filterSection.classList.add('hidden');
            quizContainer.classList.add('hidden');
            problemListSidebar.classList.add('hidden');
            errorMessage.classList.add('hidden');
            noDataMessage.classList.add('hidden');

            try {
                const response = await fetch(GOOGLE_SHEET_CSV_URL);
                if (!response.ok) {
                    throw new Error(`HTTP 오류! 상태: ${response.status}`);
                }
                const tsvText = await response.text();
                allProblems = parseTsv(tsvText);

                if (allProblems.length === 0) {
                    noDataMessage.classList.remove('hidden');
                } else {
                    populateFilters(); // 필터 드롭다운 채우기
                    loadProgress(); // 저장된 진행 상황 불러오기
                    filterSection.classList.remove('hidden'); // 필터 섹션 표시
                }
            } catch (e) {
                console.error("문제 데이터를 불러오는 데 실패했습니다:", e);
                errorMessage.classList.remove('hidden');
                errorMessage.querySelector('p').textContent = "문제 데이터를 불러오는 데 실패했습니다. Google Sheet URL을 확인하거나, 웹에 제대로 게시되었는지 확인해주세요. (콘솔 로그 확인)";
            } finally {
                loadingMessage.classList.add('hidden');
            }
        };

        // 필터 드롭다운 채우기
        const populateFilters = () => {
            const getUniqueValues = (key) => {
                const values = allProblems.map(p => p[key]).filter(Boolean); // 빈 값 제외
                // '전체' 옵션 제거
                return [...new Set(values)].sort(); 
            };

            const populateSelect = (selectElement, values) => {
                selectElement.innerHTML = ''; // 기존 옵션 초기화
                const defaultOption = document.createElement('option');
                defaultOption.value = ''; // 빈 값으로 설정하여 필터링 시 해당 조건 무시
                defaultOption.textContent = '선택하세요';
                selectElement.appendChild(defaultOption);

                values.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    selectElement.appendChild(option);
                });
            };

            const populateShiptypeSelect = (selectElement) => {
                selectElement.innerHTML = ''; 
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '선택하세요';
                selectElement.appendChild(defaultOption);

                const shiptypeValues = ['상선', '어선'];
                shiptypeValues.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    selectElement.appendChild(option);
                });
            };

            populateSelect(filterYear, getUniqueValues('연도'));
            populateSelect(filterRound, getUniqueValues('회차'));
            populateSelect(filterGrade, getUniqueValues('급수'));
            populateShiptypeSelect(filterShiptype);
        };

        // 필터 적용 및 문제풀이 시작
        const applyFilters = () => {
            const selectedYear = filterYear.value;
            const selectedRound = filterRound.value;
            const selectedGrade = filterGrade.value;
            const selectedShiptype = filterShiptype.value;

            selectedShiptypeForQuiz = selectedShiptype;

            if (!selectedYear || !selectedRound || !selectedGrade || !selectedShiptype) {
                alert("연도, 회차, 급수, 선종을 모두 선택해주세요.");
                return;
            }
            
            // 새 문제풀이를 시작할 때 저장된 진행 상황 초기화
            localStorage.removeItem(LOCAL_STORAGE_KEY);
            continueQuizButton.classList.add('hidden');

            const commonSubjects = ['항해', '운용', '법규', '영어'];
            const specializedSubject = (selectedShiptype === '상선') ? '상선전문' : '어선전문';

            filteredProblems = allProblems.filter(problem => {
                const isCommonSubject = commonSubjects.includes(problem['과목']);
                const isSpecializedSubject = problem['과목'] === specializedSubject;
                
                return (selectedYear === '' || problem['연도'] === selectedYear) &&
                       (selectedRound === '' || problem['회차'] === selectedRound) &&
                       (selectedGrade === '' || problem['급수'] === selectedGrade) &&
                       (isCommonSubject || isSpecializedSubject);
            });

            filteredProblems.sort((a, b) => {
                const indexA = subjectOrder.indexOf(a['과목']);
                const indexB = subjectOrder.indexOf(b['과목']);
                if (indexA === -1 && indexB === -1) return 0;
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });

            let currentSubject = null;
            let subjectProblemCounter = 0;
            filteredProblems.forEach(problem => {
                if (problem['과목'] !== currentSubject) {
                    currentSubject = problem['과목'];
                    subjectProblemCounter = 1;
                }
                problem.subjectProblemNumber = subjectProblemCounter;
                problem.status = 'unanswered';
                subjectProblemCounter++;
            });

            if (filteredProblems.length === 0) {
                alert("선택한 조건에 맞는 문제가 없습니다. 필터를 다시 설정해주세요.");
                return;
            }

            currentProblemIndex = 0;
            startQuiz();
        };

        // 문제풀이 시작 (필터링된 문제로)
        const startQuiz = () => {
            filterSection.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            problemListSidebar.classList.remove('hidden');
            displayProblem();
            updateProblemListSidebar();
        };
        
        // 로컬 스토리지에서 진행 상황 불러오기
        const loadProgress = () => {
            const savedProgress = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedProgress) {
                const progress = JSON.parse(savedProgress);
                filteredProblems = progress.filteredProblems;
                currentProblemIndex = progress.currentProblemIndex;
                selectedShiptypeForQuiz = progress.selectedShiptypeForQuiz;
                
                continueQuizButton.classList.remove('hidden');
                continueQuizButton.onclick = () => {
                    startQuiz();
                };

                // 필터 드롭다운에 저장된 값 표시
                filterYear.value = filteredProblems[0]['연도'] || '';
                filterRound.value = filteredProblems[0]['회차'] || '';
                filterGrade.value = filteredProblems[0]['급수'] || '';
                filterShiptype.value = selectedShiptypeForQuiz || '';

                console.log("저장된 진행 상황을 불러왔습니다.");
            } else {
                continueQuizButton.classList.add('hidden');
            }
        };

        // 현재 진행 상황을 로컬 스토리지에 저장
        const saveProgress = () => {
            const progress = {
                filteredProblems,
                currentProblemIndex,
                selectedShiptypeForQuiz,
            };
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(progress));
            console.log("진행 상황을 저장했습니다.");
        };

        // 현재 문제를 화면에 표시하는 함수
        const displayProblem = () => {
            const currentProblem = filteredProblems[currentProblemIndex];
            
            problemMetaYear.textContent = currentProblem['연도'] || '';
            problemMetaRound.textContent = currentProblem['회차'] || '';
            problemMetaGrade.textContent = currentProblem['급수'] || '';
            problemMetaShiptype.textContent = selectedShiptypeForQuiz || ''; 
            problemMetaSubject.textContent = currentProblem['과목'] || '';

            problemNumberSpan.textContent = `${currentProblem.subjectProblemNumber}.`;
            problemQuestionSpan.textContent = currentProblem['문제'] || '문제 내용을 불러올 수 없습니다.';
            optionsList.innerHTML = '';

            ['보기1', '보기2', '보기3', '보기4'].forEach((optionKey) => {
                const li = document.createElement('li');
                const button = document.createElement('button');
                button.textContent = `${optionLabels[optionKey]}. ${currentProblem[optionKey] || ''}`; 
                button.className = `
                    w-full text-left p-3 rounded-lg border-2 transition-all duration-200
                    bg-gray-50 border-gray-300 hover:bg-blue-50 hover:border-blue-400 text-gray-700
                    cursor-pointer
                `;
                button.onclick = () => handleAnswer(optionKey);
                li.appendChild(button);
                optionsList.appendChild(li);
            });

            solutionArea.classList.add('hidden');
            solutionText.textContent = '';
            showSolution = false;
            isAnsweredCorrectly = null;
            updateProblemListSidebar();
            saveProgress(); // 문제 변경 시 자동 저장
        };

        // 문제 목록 사이드바 업데이트
        const updateProblemListSidebar = () => {
            sidebarProblemNumbers.innerHTML = '';
            let currentSubjectDisplayed = null;

            filteredProblems.forEach((problem, index) => {
                if (problem['과목'] !== currentSubjectDisplayed) {
                    currentSubjectDisplayed = problem['과목'];
                    const subjectHeadingLi = document.createElement('li');
                    subjectHeadingLi.className = 'col-span-5 text-left mt-4 mb-1 text-gray-800 font-bold text-base border-b pb-1 border-gray-300';
                    subjectHeadingLi.textContent = currentSubjectDisplayed;
                    sidebarProblemNumbers.appendChild(subjectHeadingLi);
                }

                const li = document.createElement('li');
                const button = document.createElement('button');
                button.textContent = `${problem.subjectProblemNumber}`; 
                
                let statusClass = 'bg-gray-200 text-gray-700 hover:bg-gray-300';
                if (problem.status === 'correct') {
                    statusClass = 'bg-green-200 text-green-800';
                } else if (problem.status === 'incorrect') {
                    statusClass = 'bg-red-200 text-red-800';
                }

                button.className = `
                    p-2 rounded-md transition-colors duration-150 text-center
                    flex items-center justify-center w-10 h-10 flex-shrink-0
                    ${index === currentProblemIndex
                        ? 'bg-blue-600 text-white font-bold shadow-sm'
                        : statusClass
                    }
                `;
                button.onclick = () => {
                    currentProblemIndex = index;
                    displayProblem();
                };
                li.appendChild(button);
                sidebarProblemNumbers.appendChild(li);
            });

            const activeProblemButton = sidebarProblemNumbers.querySelector('.bg-blue-600');
            if (activeProblemButton) {
                activeProblemButton.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        };

        const handleAnswer = (selectedOptionKey) => {
            if (showSolution) return;

            const currentProblem = filteredProblems[currentProblemIndex];
            const correctOptionLabelFromSheet = currentProblem['정답'];

            let actualCorrectOptionKey = null;
            for (const key in optionLabels) {
                if (optionLabels[key] === correctOptionLabelFromSheet) {
                    actualCorrectOptionKey = key;
                    break;
                }
            }
            
            const optionButtons = optionsList.querySelectorAll('button');
            optionButtons.forEach(button => {
                button.disabled = true;
                button.classList.remove('cursor-pointer');
                button.classList.add('cursor-not-allowed');
                button.classList.remove('bg-gray-50', 'border-gray-300', 'hover:bg-blue-50', 'hover:border-blue-400', 'text-gray-700');
            });

            optionButtons.forEach(button => {
                const buttonTextPrefix = button.textContent.split('.')[0].trim();
                let buttonOptionKey = null;
                for (const key in optionLabels) {
                    if (optionLabels[key] === buttonTextPrefix) {
                        buttonOptionKey = key;
                        break;
                    }
                }

                if (buttonOptionKey === actualCorrectOptionKey) {
                    button.classList.add('bg-green-100', 'border-green-500', 'text-green-800', 'font-bold');
                } else if (buttonOptionKey === selectedOptionKey) {
                    button.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                }
            });

            if (selectedOptionKey === actualCorrectOptionKey) {
                isAnsweredCorrectly = true;
                showSolution = false;
                filteredProblems[currentProblemIndex].status = 'correct';
                setTimeout(() => {
                    handleNextProblem();
                }, 1000);
            } else {
                isAnsweredCorrectly = false;
                showSolution = true;
                filteredProblems[currentProblemIndex].status = 'incorrect';
                solutionArea.classList.remove('hidden');
                solutionText.textContent = currentProblem['풀이'] || '풀이 내용을 불러올 수 없습니다.';
            }
            updateProblemListSidebar();
        };

        const handleNextProblem = () => {
            showSolution = false;
            isAnsweredCorrectly = null;
            solutionArea.classList.add('hidden');

            if (currentProblemIndex < filteredProblems.length - 1) {
                currentProblemIndex++;
                displayProblem();
            } else {
                alert("모든 문제를 풀었습니다! 처음으로 돌아갑니다.");
                currentProblemIndex = 0;
                displayProblem();
            }
        };

        // 필터 화면으로 돌아가는 기능
        const backToHome = () => {
            filterSection.classList.remove('hidden');
            quizContainer.classList.add('hidden');
            problemListSidebar.classList.add('hidden');
            // 로컬 스토리지에 저장된 내용이 있다면 '이어하기' 버튼 표시
            if (localStorage.getItem(LOCAL_STORAGE_KEY)) {
                continueQuizButton.classList.remove('hidden');
            } else {
                continueQuizButton.classList.add('hidden');
            }
        };

        // 이벤트 리스너 연결
        startQuizButton.addEventListener('click', applyFilters);
        nextProblemButton.addEventListener('click', handleNextProblem);
        backToHomeButton.addEventListener('click', backToHome);

        // 페이지 로드 시 문제 데이터 불러오기
        window.onload = fetchProblems;
    </script>
</body>
</html>
